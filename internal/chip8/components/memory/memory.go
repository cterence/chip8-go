package memory

import (
	"fmt"

	"github.com/cterence/chip8-go/internal/lib"
)

type Memory struct {
	ram [RAM_SIZE]byte
}

const (
	RAM_SIZE uint16 = 0xFFFF

	INTERPRETER_RAM_START uint16 = 0
	INTERPRETER_RAM_END   uint16 = 0x1FF

	PROGRAM_RAM_START uint16 = INTERPRETER_RAM_END + 1
	PROGRAM_RAM_END   uint16 = RAM_SIZE
	PROGRAM_RAM_SIZE  uint16 = PROGRAM_RAM_END - PROGRAM_RAM_START
)

func New() *Memory {
	m := &Memory{}

	return m
}

func (m *Memory) Init() {
	fontSprites := [16 * 5]byte{
		0xF0, 0x90, 0x90, 0x90, 0xF0,
		0x20, 0x60, 0x20, 0x20, 0x70,
		0xF0, 0x10, 0xF0, 0x80, 0xF0,
		0xF0, 0x10, 0xF0, 0x10, 0xF0,
		0x90, 0x90, 0xF0, 0x10, 0x10,
		0xF0, 0x80, 0xF0, 0x10, 0xF0,
		0xF0, 0x80, 0xF0, 0x90, 0xF0,
		0xF0, 0x10, 0x20, 0x40, 0x40,
		0xF0, 0x90, 0xF0, 0x90, 0xF0,
		0xF0, 0x90, 0xF0, 0x10, 0xF0,
		0xF0, 0x90, 0xF0, 0x90, 0x90,
		0xE0, 0x90, 0xE0, 0x90, 0xE0,
		0xF0, 0x80, 0x80, 0x80, 0xF0,
		0xE0, 0x90, 0x90, 0x90, 0xE0,
		0xF0, 0x80, 0xF0, 0x80, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0x80,
	}

	for i := range fontSprites {
		m.Write(uint16(i), fontSprites[i])
	}

	superFontSprites := [16 * 10]byte{
		0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF,
		0x0C, 0x0C, 0x3C, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x3F,
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF,
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF,
		0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF,
		0xFF, 0xFF, 0x03, 0x03, 0x0C, 0x0C, 0x30, 0x30, 0x30, 0x30,
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF,
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF,
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3,
		0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC,
		0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF,
		0xFC, 0xFC, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFC, 0xFC,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0,
	}

	for i := range superFontSprites {
		m.Write(uint16(i+len(fontSprites)), superFontSprites[i])
	}
}

func (m *Memory) Read(a uint16) byte {
	lib.Assert(a < RAM_SIZE, fmt.Errorf("address must be lower than 0x%03X, actual 0x%03X", RAM_SIZE, a))

	return m.ram[a]
}

func (m *Memory) Write(a uint16, v byte) {
	lib.Assert(a < RAM_SIZE, fmt.Errorf("address must be lower than 0x%03X, actual 0x%03X", RAM_SIZE, a))

	m.ram[a] = v
}
